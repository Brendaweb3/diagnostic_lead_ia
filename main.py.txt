import streamlit as st
import re
import io
from reportlab.lib.pagesizes import A4
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Image
from reportlab.lib.styles import getSampleStyleSheet

st.set_page_config(page_title="Diagnostic Architect IA", page_icon="ü§ñ", layout="centered")

def generate_pdf_bytes(name_or_company, email, responses, score, conclusion):
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4)
    elements = []
    styles = getSampleStyleSheet()
    try:
        elements.append(Image("assets/logo_brendabox.png", width=160, height=60))
    except Exception:
        elements.append(Paragraph("(Logo manquant)", styles["Normal"]))
    elements.append(Spacer(1, 20))
    elements.append(Paragraph(f"<b>Diagnostic pour :</b> {name_or_company}", styles["Heading2"]))
    elements.append(Paragraph(f"<b>Email :</b> {email}", styles["Normal"]))
    elements.append(Spacer(1, 12))
    elements.append(Paragraph(f"<b>Score :</b> {score}", styles["Normal"]))
    elements.append(Spacer(1, 12))
    elements.append(Paragraph(f"<b>Conclusion :</b> {conclusion}", styles["Normal"]))
    elements.append(Spacer(1, 24))
    elements.append(Paragraph("<b>R√©ponses</b>", styles["Heading3"]))
    for question, rep in responses.items():
        elements.append(Paragraph(f"{question}: {rep}", styles["Normal"]))
    doc.build(elements)
    pdf = buffer.getvalue()
    buffer.close()
    return pdf

st.title("Diagnostic IA Lead Qualifi√© üöÄ")

with st.form("formulaire_diagnostic"):
    name_or_company = st.text_input("Nom ou soci√©t√© (obligatoire)")
    email = st.text_input("Email (obligatoire)")
    appel = st.checkbox("Prendre RDV avec Bernadette")
    st.markdown("*L'appel est facultatif : le PDF d'audit est envoy√© par email.*")

    q1 = st.radio("Votre entreprise utilise-t-elle d√©j√† des outils IA ?", ["Oui", "Non"])
    q2 = st.slider("Quel est votre niveau de maturit√© digitale ?", 0, 10, 5)
    q3 = st.text_area("Commentaires libres")

    envoyer = st.form_submit_button("Obtenir mon audit PDF")

if envoyer:
    if not name_or_company:
        st.error("Veuillez renseigner le nom ou la soci√©t√©.")
    elif not email:
        st.error("L'email est obligatoire pour recevoir l'audit.")
    elif not re.match(r"[^@]+@[^@]+\.[^@]+", email):
        st.error("Merci de saisir un email valide.")
    else:
        score = int(q2)
        conclusion = "Bravo, vous √™tes pr√™t pour la prochaine √©tape IA !" if score > 5 else "Accompagnement recommand√© pour booster votre transformation."
        responses = {
            "Outils IA ?": q1,
            "Maturit√© digitale": q2,
            "Commentaires": q3
        }
        pdf_bytes = generate_pdf_bytes(name_or_company, email, responses, score, conclusion)
        st.success("Votre audit personnalis√© a √©t√© cr√©√©¬†!")
        st.download_button("T√©l√©charger l'audit PDF", pdf_bytes, file_name="audit_ia.pdf", mime="application/pdf")
        st.markdown("[Prendre rendez-vous Zoom avec Bernadette](https://calendly.com/bernadette-brendaboxia/15mn)")

# Pour lancer¬†: python -m streamlit run main.py
